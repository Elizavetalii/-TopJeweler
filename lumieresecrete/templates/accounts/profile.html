{% extends "base.html" %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å ‚Äî Lumiere Secr√®te{% endblock %}

{% block hero %}
<section class="catalog-hero">
    <div class="hero-content">
        <p class="eyebrow">–ê–∫–∫–∞—É–Ω—Ç</p>
        <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
        <p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞.</p>
    </div>
</section>
{% endblock %}

{% block content %}
<div class="profile-layout">
    <aside class="profile-sidebar">
        <div class="profile-card">
            <div class="notification-panel">
                <button type="button" class="notification-bell {% if unread_notifications %}is-active{% endif %}" data-bell-toggle {% if unread_notifications %}data-unread="true"{% endif %}>
                    üîî
                    {% if unread_notifications %}
                    <span class="notification-badge">{{ unread_notifications }}</span>
                    {% endif %}
                </button>
                <div class="notification-dropdown" data-bell-dropdown hidden>
                    <p class="muted">–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤</p>
                    {% if notifications %}
                    <ul>
                        {% for note in notifications %}
                        <li>
                            <strong>–ó–∞–∫–∞–∑ ‚Ññ{{ note.order.order_id }}</strong><br>
                            {{ note.old_status|default:"‚Äî" }} ‚Üí {{ note.new_status|default:"‚Äî" }}<br>
                            <span class="muted">{{ note.created_at|date:"d.m.Y H:i" }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç.</p>
                    {% endif %}
                </div>
            </div>
            <div class="profile-avatar">
                {{ request.user.first_name|default:request.user.username|first|upper }}
            </div>
            <div class="profile-meta">
                <h2>{{ request.user.get_full_name|default:request.user.username }}</h2>
                <p>{{ request.user.email }}</p>
            </div>
            <dl>
                <div>
                    <dt>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</dt>
                    <dd>{{ formatted_date_joined }}</dd>
                </div>
                <div>
                    <dt>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</dt>
                    <dd>{{ formatted_last_login }}</dd>
                </div>
            </dl>
        </div>
        <div class="profile-tip">
            {% if allow_catalog_preferences %}
            <p>–ó–¥–µ—Å—å –≤—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ —Ç–µ–º–æ–π —Å–∞–π—Ç–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏ –≤–∏–¥–æ–º –∏–∫–æ–Ω–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ. –ù–∏–∂–µ –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å.</p>
            {% else %}
            <p>–ó–¥–µ—Å—å –≤—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ —Ç–æ–ª—å–∫–æ —Ç–µ–º–æ–π –∏ —Ñ–æ—Ä–º–∞—Ç–æ–º –¥–∞—Ç—ã. –ù–∏–∂–µ –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å.</p>
            {% endif %}
        </div>
    </aside>

    <section class="profile-main">
        <div class="profile-section">
            <div class="section-head">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h2>
                <span class="muted">–ü—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</span>
            </div>
            <form method="post" class="profile-form">
                {% csrf_token %}
                <input type="hidden" name="intent" value="settings">
                <div class="form-grid">
                    <label>
                        <span>–¢–µ–º–∞</span>
                        {{ form.theme }}
                    </label>
                    <label>
                        <span>–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã</span>
                        {{ form.date_format }}
                    </label>
                    {% if allow_catalog_preferences %}
                    <label>
                        <span>–ö–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</span>
                        {{ form.page_size }}
                    </label>
                    {% endif %}
                </div>
                {% if allow_catalog_preferences %}
                <div class="favorite-choice">
                    <p>–ò–∫–æ–Ω–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ</p>
                    <div class="favorite-choice__options">
                        {% for value, label in form.favorite_icon.field.choices %}
                        <label class="choice-pill">
                            {% with current=form.favorite_icon.value %}
                            <input type="radio" name="{{ form.favorite_icon.name }}" value="{{ value }}" {% if current == value %}checked{% endif %}>
                            <span>
                                <span class="choice-icon {% if value == 'star' %}choice-icon--star{% endif %}"></span>
                                {{ label }}
                            </span>
                            {% endwith %}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% if form.errors %}
                <ul class="form-errors">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
                {% endif %}
                <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>

        <div class="profile-section">
            <div class="section-head">
                <h2>–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h2>
                <span class="muted">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Å–∏–º–≤–æ–ª–æ–≤</span>
            </div>
            <form method="post" class="profile-form">
                {% csrf_token %}
                <input type="hidden" name="intent" value="password">
                <div class="form-grid">
                    <label>
                        <span>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</span>
                        {{ password_form.old_password }}
                    </label>
                    <label>
                        <span>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</span>
                        {{ password_form.new_password1 }}
                    </label>
                    <label>
                        <span>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</span>
                        {{ password_form.new_password2 }}
                    </label>
                </div>
                {% if password_form.errors %}
                <ul class="form-errors">
                    {% for field, errors in password_form.errors.items %}
                        {% for error in errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
                {% endif %}
                <button type="submit" class="btn-primary">–û–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            </form>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const toggle = document.querySelector('[data-bell-toggle]');
  const dropdown = document.querySelector('[data-bell-dropdown]');
  if (!toggle || !dropdown) {
    return;
  }
  toggle.addEventListener('click', function () {
    dropdown.toggleAttribute('hidden');
    if (dropdown.hasAttribute('hidden')) {
      return;
    }
    if (!toggle.dataset.unread) {
      return;
    }
    fetch("{% url 'accounts:notifications_mark_read' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest'
      },
    }).then(function () {
      toggle.classList.remove('is-active');
      toggle.removeAttribute('data-unread');
      const badge = toggle.querySelector('.notification-badge');
      if (badge) {
        badge.remove();
      }
    });
  });
});

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// –¢–µ–º–∞ —Å–∞–π—Ç–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (UserSettings.theme)
// –õ–æ–∫–∞–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º –≤—ã–±–æ—Ä —Å–µ–ª–µ–∫—Ç–∞ —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª —ç—Ñ—Ñ–µ–∫—Ç –¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', function(){
  try {
    const form = document.querySelector('form.profile-form input[name="intent"][value="settings"]')?.closest('form');
    if (!form) return;
    const select = form.querySelector('select[name="theme"], [name="theme"]');
    const apply = function(theme){
      var dark = theme === 'dark';
      document.documentElement.classList.toggle('pref-theme-dark', dark);
      document.body.classList.toggle('pref-theme-dark', dark);
    };
    if (select){
      apply(select.value === 'dark' ? 'dark' : 'light');
      select.addEventListener('change', function(){
        const t = select.value === 'dark' ? 'dark' : 'light';
        apply(t);
        try { localStorage.setItem('ls-theme', t); } catch(e){}
      });
    }
  } catch(e){}
});
</script>
{% endblock %}
