{% extends "base.html" %}
{% load static %}

{% block title %}Избранное — Lumiere Secrète{% endblock %}

{% block hero %}
<section class="catalog-hero">
    <div class="hero-content">
        <p class="eyebrow">Подборка</p>
        <h1>Избранное <span data-wishlist-count>({{ wishlist_count }})</span></h1>
        <p>Сохраняйте образы, фильтруйте, сортируйте и отправляйте в корзину в один клик.</p>
    </div>
</section>
{% endblock %}

{% block content %}
<section class="wishlist-page" data-wishlist-page>
    <header class="wishlist-header">
        <div class="wishlist-actions">
            {% if bulk_add_url %}
            <form method="post" action="{{ bulk_add_url }}">
                {% csrf_token %}
                <button
                    type="submit"
                    class="btn-primary"
                    data-wishlist-add-all
                    data-url="{{ bulk_add_url }}"
                    {% if not items %}disabled{% endif %}
                >Добавить всё в корзину</button>
            </form>
            {% else %}
            <button type="button" class="btn-primary" disabled>Добавить всё в корзину</button>
            {% endif %}
            <form method="post" action="{{ clear_url }}" class="wishlist-clear-form">
                {% csrf_token %}
                <button type="submit" class="btn-link">Очистить список</button>
            </form>
        </div>
        {% if not can_checkout %}
        <a class="btn-primary small" href="{{ login_url }}">Войти, чтобы оформить заказ</a>
        {% endif %}
    </header>

    <form method="get" class="wishlist-filters" id="wishlistFilters">
        <div class="wishlist-search">
            <span class="wishlist-search__icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="7"></circle>
                    <line x1="16.65" y1="16.65" x2="21" y2="21"></line>
                </svg>
            </span>
            <input type="search" name="q" placeholder="Поиск по избранному" value="{{ filters.search }}" data-hotkey-search>
        </div>
        <label class="checkbox checkbox--inline">
            <input type="checkbox" name="in_stock" value="1" {% if filters.in_stock %}checked{% endif %}>
            <span>Только в наличии</span>
        </label>
        <div class="wishlist-select">
            <span class="wishlist-select__label">Магазин</span>
            <select name="store">
                <option value="">Все бутики</option>
                {% for store in filters.stores %}
                    <option value="{{ store.id }}" {% if store.id|stringformat:'s' == filters.store %}selected{% endif %}>{{ store.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="wishlist-select">
            <span class="wishlist-select__label">Сортировка</span>
            <select name="sort">
                <option value="newest" {% if filters.sort == 'newest' %}selected{% endif %}>Сначала новые</option>
                <option value="cheap" {% if filters.sort == 'cheap' %}selected{% endif %}>Дешевле</option>
                <option value="expensive" {% if filters.sort == 'expensive' %}selected{% endif %}>Дороже</option>
            </select>
        </div>
        <button type="submit" class="btn-link wishlist-submit">Применить</button>
    </form>

    {% if items %}
    <div
        class="wishlist-grid"
        data-wishlist-grid
        data-cart-url="{{ cart_add_url|default:'' }}"
        data-login-url="{{ login_url }}"
        data-bulk-url="{{ bulk_add_url|default:'' }}"
        data-clear-url="{{ clear_url }}"
        data-can-checkout="{{ can_checkout|yesno:'true,false' }}"
    >
        {% for item in items %}
        <article class="wishlist-card" data-wishlist-card data-product-id="{{ item.product_id }}" data-variant-id="{{ item.variant_id }}" data-favorite-url="{{ item.favorite_url }}">
            <div class="wishlist-card__media">
                <img src="{{ item.image }}" alt="{{ item.name }}" loading="lazy">
                <span class="badge {% if item.in_stock %}badge-new{% else %}badge-out{% endif %}">
                    {% if item.in_stock %}В наличии{% else %}Нет{% endif %}
                </span>
                <form method="post" action="{{ item.favorite_url }}" class="wishlist-like-form">
                    {% csrf_token %}
                    <button
                        type="submit"
                        class="favorite-btn favorite-btn--ghost wishlist-like"
                        data-favorite-toggle
                        data-manual-favorite="true"
                        data-url="{{ item.favorite_url }}"
                        aria-label="Убрать из избранного"
                    >
                        <span class="heart-icon" aria-hidden="true"></span>
                    </button>
                </form>
            </div>
            <div class="wishlist-card__body">
                <div>
                    <a href="{{ item.detail_url }}" class="wishlist-card__title">{{ item.name }}</a>
                    <p class="muted text-sm">{{ item.store_name }}</p>
                    <p class="muted">{{ item.color }} · {{ item.size }}</p>
                </div>
                <div class="wishlist-card__footer">
                    {% if item.price %}
                        <p class="product-price">{{ item.price }} ₽</p>
                    {% else %}
                        <p class="muted">Цена уточняется</p>
                    {% endif %}
                    <div class="wishlist-card__controls">
                     
                        {% if can_checkout %}
                            {% if cart_add_url and item.variant_id %}
                            <form method="post" action="{{ cart_add_url }}" class="wishlist-card__cta-form">
                                {% csrf_token %}
                                <input type="hidden" name="product_variant_id" value="{{ item.variant_id }}">
                                <input type="hidden" name="quantity" value="1">
                                <button
                                    type="submit"
                                    class="btn-primary btn-small"
                                    data-wishlist-add-cart
                                    data-variant="{{ item.variant_id }}"
                                    {% if not item.in_stock %}disabled{% endif %}
                                >
                                    {% if item.in_stock %}Добавить в корзину{% else %}Нет в наличии{% endif %}
                                </button>
                            </form>
                            {% else %}
                            <button class="btn-primary btn-small" disabled>Нет варианта</button>
                            {% endif %}
                        {% else %}
                            <a class="btn-primary btn-small" href="{{ login_url }}">Войти</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </article>
        {% endfor %}
    </div>

    {% if next_page_url %}
    <div class="wishlist-load-more">
        <a class="btn-link" href="{{ next_page_url }}">Показать ещё</a>
    </div>
    {% endif %}
    {% else %}
    <div class="empty-state">
        <img src="https://placehold.co/320x160/F1ECE6/2E2E2E?text=Wishlist" alt="Пустой список">
        <p>В избранном пока ничего нет. Загляните в <a href="{% url 'catalog_list' %}">каталог</a>.</p>
    </div>
    {% endif %}
</section>
{% endblock %}

{% block extra_js %}
<script src="{% static 'catalog/cart_wishlist.js' %}" defer></script>
{% endblock %}
